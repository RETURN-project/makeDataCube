---
title: "Generate Landsat data cube"
author: "Wanda De Keersmaecker"
date: "6/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = T)
library(reticulate)
library(makeDataCube)
library(tidyverse)
library(sf)

# Find Python in this machine
## Default installation folder for Python with Anaconda, including the user name
py_location <- file.path("/home", Sys.getenv("USER"), "anaconda3/bin/python")
use_python(py_location, required = TRUE)
py_config()
```
# General
This document generates a data cube of level-2 Landsat and Sentinel-2 data over a user-defined area and study period, using only Landsat data below a user-defined cloud coverage threshold. The Landsat Level-1 scenes are downloaded from the public dataset hosted on Google Cloud, while Sentinel-2 Level-1 scenes should be available locally. These scenes are processed to Level-2 and a data cube is generated using FORCE software.

## Requirements
- Python 3 should be installed and the pylandsat (https://pypi.org/project/pylandsat/) and shapely modules should be available to download data. pylandsat can be installed via 'pip install pylandsat'.
- In addition, FORCE should be installed. FORCE allows to generate a data cube of level-2 (or higher) Landsat and Sentinel-2 imagery from level-1 inputs. Please visit https://github.com/davidfrantz/force for more information and download instructions. 
- Next, the user should have a NASA Earthdata account to download DEM data. The Login Username and Password are stored in a netrc file in the home dir. If no netrc file is found, you will be asked to provide your Username and Password and a netrc file will automatically be created (and stored for a next session). If you don't have an account yet, you can create one at: urs.earthdata.nasa.gov. 
- Finally, you need authentification to download data from the LAADS DAAC (WVP data). To that end, you need an create a .laads file is in your home directory with a an App Key. The App Key can be requested from NASA Earthdata (https://ladsweb.modaps.eosdis.nasa.gov/tools-and-services/data-download-scripts/#requesting). This key should be put in a file .laads in your home directory.

# Inputs
```{r}
forcefolder <- normalizePath(file.path('..', 'data'))#'/home/wanda/Documents/data/force_small' #file.path('..', 'data')#forcefolder <- '/home/wanda/Documents/data/force'
S2folder <- normalizePath(file.path('..', 'data'))# folder where Level-1 Sentinel-2 data are stored
ext <- c(-43.38238361637443,-43.27938679020256,-4.555765244985907,-4.451717415449725)#extent, vector with xmin, xmax, ymin, ymax in degrees
cld <- 50 # maximum cloud cover
starttime <- c(2000,11,01)#start date: year, month, day
endtime <- c(2001,5,28)#end date: year, month, day
tiers <- 'T1'#Tier level
sensors <- c('LC08', 'LE07', 'LT05', 'LT04')#sensors, 'LM05', 'LM04'
```

# Generate the directory structure
```{r}
# generate folder structure
fldrs <- setFolders(forcefolder)
tmpfolder <- fldrs['tmpfolder']
l1folder <- fldrs['l1folder']
l2folder <- fldrs['l2folder']
queuefolder <- fldrs['queuefolder']
queuefile <- fldrs['queuefile']
demfolder <- fldrs['demfolder']
wvpfolder <- fldrs['wvpfolder']
logfolder <- fldrs['logfolder']
paramfolder <- fldrs['paramfolder']
paramfile <- 'l2param.prm'
demlogfile <- fldrs['demlogfile']
wvplogfile <- fldrs['wvplogfile']
landsatlogfile <- fldrs['landsatlogfile']
Sskiplogfile <- fldrs['Sskiplogfile']
Ssuccesslogfile <- fldrs['Ssuccesslogfile']
Smissionlogfile <- fldrs['Smissionlogfile']
Sotherlogfile <- fldrs['Sotherlogfile']
S2auxfolder <- fldrs['S2auxfolder']
```

# Generate a parameter file
```{r}
# more information about the parameter settings can be found in https://davidfrantz.github.io/tutorials/force-ard/l2-ard/
# or https://force-eo.readthedocs.io/en/latest/components/lower-level/level2/param.html
source_python('../python/makeParFile.py')

makeParFile(paramfolder, file.path(paramfolder, paramfile), FILE_QUEUE = file.path(queuefolder, queuefile), DIR_LEVEL2 = l2folder, DIR_LOG = logfolder, DIR_TEMP = tmpfolder, FILE_DEM = file.path(demfolder,'srtm.vrt'), ORIGIN_LON = '-90', ORIGIN_LAT = '60', RESAMPLING = 'NN', DIR_WVPLUT = wvpfolder, RES_MERGE = 'REGRESSION',  NPROC = '1', NTHREAD = '1', DELAY = '10', OUTPUT_DST = 'TRUE',  OUTPUT_VZN = 'TRUE', OUTPUT_HOT = 'TRUE', OUTPUT_OVV = 'TRUE', DEM_NODATA= '-32768',TILE_SIZE = '3000',BLOCK_SIZE = '300')
```
 
# Search Landsat scenes, download and add to queue
```{r}
LSscenes <- dllLS(l1folder, queuefolder, queuefile, tmpfolder, landsatlogfile, ext, starttime, endtime, sensors, tiers, cld)
```

# Add Sentinel-2 data to queue
```{r}
addSen2queue(S2auxfolder, ext, S2folder, starttime, endtime, queuefolder, queuefile, l1folder)
```

# Download the DEM and generate a VRT
```{r}
# download DEM over study area
flsDEM <- dllDEM(ext, dl_dir= demfolder, logfile = demlogfile)

# generate a vrt
system(paste0("find ",demfolder," -name '*.hgt' > ",file.path(demfolder,'srtm.txt')), intern = TRUE, ignore.stderr = TRUE)
system(paste0("gdalbuildvrt -input_file_list ",file.path(demfolder,'srtm.txt')," ",file.path(demfolder,'srtm.vrt')))
```

# Download the WVP data
```{r}
dllWVP(wvpfolder, logfile = wvplogfile)
```

# Process the level 1 data to level 2 and generate a vrt

- process data to level 2
- generate vrt
- summarize log files of all scenes
```{r}
Landsat2L2(paramfolder, paramfile, l2folder, LSscenes, logfolder, Sskiplogfile, Ssuccesslogfile, Smissionlogfile, Sotherlogfile)
```

