---
title: "Generate Landsat data cube"
author: "Wanda De Keersmaecker"
date: "6/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = T)
library(reticulate)
library(makeDataCube)
library(tidyverse)
library(sf)

# Find Python in this machine
## Default installation folder for Python with Anaconda, including the user name
py_location <- file.path("/home", Sys.getenv("USER"), "anaconda3/bin/python")
use_python(py_location, required = TRUE)
py_config()
```
# General
This document generates a data cube of level-2 Landsat data over a user-defined area and study period, using only data below a user-defined cloud coverage threshold. 

## Requirements
- Python 3 should be installed and the pylandsat (https://pypi.org/project/pylandsat/) and shapely modules should be available to download data. pylandsat can be installed via 'pip install pylandsat'.
- In addition, FORCE should be installed. FORCE allows to generate a data cube of level-2 (or higher) Landsat and Sentinel-2 imagery from level-1 inputs. Please visit https://github.com/davidfrantz/force for more information and download instructions. 
- Next, the user should have a NASA Earthdata account to download DEM data. The Login Username and Password are stored in a netrc file in the home dir. If no netrc file is found, you will be asked to provide your Username and Password and a netrc file will automatically be created (and stored for a next session). If you don't have an account yet, you can create one at: urs.earthdata.nasa.gov. 
- Finally, you need authentification to download data from the LAADS DAAC (WVP data). To that end, you need an create a .laads file is in your home directory with a an App Key. The App Key can be requested from NASA Earthdata (https://ladsweb.modaps.eosdis.nasa.gov/tools-and-services/data-download-scripts/#requesting). This key should be put in a file .laads in your home directory.

# Inputs
```{r}
forcefolder <- normalizePath(file.path('..', 'data'))#'/home/wanda/Documents/data/force_small' #file.path('..', 'data')#forcefolder <- '/home/wanda/Documents/data/force'
S2folder <- normalizePath(file.path('..', 'data'))# folder where Level-1 Sentinel-2 data are stored
ext <- c(-43.38238361637443,-43.27938679020256,-4.555765244985907,-4.451717415449725)#extent, vector with xmin, xmax, ymin, ymax in degrees
cld <- 50 # maximum cloud cover
starttime <- c(2000,11,01)#start date: year, month, day
endtime <- c(2001,5,28)#end date: year, month, day
tiers <- 'T1'#Tier level
sensors <- c('LC08', 'LE07', 'LT05', 'LT04')#sensors, 'LM05', 'LM04'
```

# Generate the directory structure
```{r}
# generate folder structure
fldrs <- setFolders(forcefolder)
tmpfolder <- fldrs['tmpfolder']
l1folder <- fldrs['l1folder']
l2folder <- fldrs['l2folder']
queuefolder <- fldrs['queuefolder']
queuefile <- fldrs['queuefile']
demfolder <- fldrs['demfolder']
wvpfolder <- fldrs['wvpfolder']
logfolder <- fldrs['logfolder']
paramfolder <- fldrs['paramfolder']
paramfile <- 'l2param.prm'
demlogfile <- fldrs['demlogfile']
wvplogfile <- fldrs['wvplogfile']
landsatlogfile <- fldrs['landsatlogfile']
Sskiplogfile <- fldrs['Sskiplogfile']
Ssuccesslogfile <- fldrs['Ssuccesslogfile']
Smissionlogfile <- fldrs['Smissionlogfile']
Sotherlogfile <- fldrs['Sotherlogfile']
S2auxfolder <- fldrs['S2auxfolder']
```

# Generate a parameter file
```{r}
# more information about the parameter settings can be found in https://davidfrantz.github.io/tutorials/force-ard/l2-ard/
# or https://force-eo.readthedocs.io/en/latest/components/lower-level/level2/param.html
source_python('../python/makeParFile.py')

makeParFile(paramfolder, file.path(paramfolder, paramfile), FILE_QUEUE = file.path(queuefolder, queuefile), DIR_LEVEL2 = l2folder, DIR_LOG = logfolder, DIR_TEMP = tmpfolder, FILE_DEM = file.path(demfolder,'srtm.vrt'), ORIGIN_LON = '-90', ORIGIN_LAT = '60', RESAMPLING = 'NN', DIR_WVPLUT = wvpfolder, RES_MERGE = 'REGRESSION',  NPROC = '1', NTHREAD = '1', DELAY = '10', OUTPUT_DST = 'TRUE',  OUTPUT_VZN = 'TRUE', OUTPUT_HOT = 'TRUE', OUTPUT_OVV = 'TRUE', DEM_NODATA= '-32768',TILE_SIZE = '3000',BLOCK_SIZE = '300')
```
 
# Search Landsat scenes, download and add to queue
```{r}
LSscenes <- dllLS(l1folder, queuefolder, queuefile, tmpfolder, landsatlogfile, ext, starttime, endtime, sensors, tiers, cld)
```

# Add Sentinel-2 data to queue
```{r}
# get the Sentinel-2 tile grid
if(!file.exists(file.path(S2auxfolder, 'S2grid.kml'))){
  download.file('https://sentinel.esa.int/documents/247904/1955685/S2A_OPER_GIP_TILPAR_MPC__20151209T095117_V20150622T000000_21000101T000000_B00.kml', file.path(S2auxfolder, 'S2grid.kml'))
}
s2grid <- st_read(file.path(S2auxfolder, 'S2grid.kml'),'Features')

# search which tiles intersect with area of interest
df <- data.frame(
  lon = c(ext[1], ext[2], ext[2], ext[1], ext[1]),
  lat = c(ext[3], ext[3], ext[4], ext[4], ext[3])
)
aoi <- df %>%
  st_as_sf(coords = c("lon", "lat"), crs = 4326) %>%
  summarise(geometry = st_combine(geometry)) %>%
  st_cast("POLYGON")#polygon with area of interest

tiles <- s2grid[which(st_within(s2grid, aoi, sparse = F) == T | st_intersects(s2grid, aoi, sparse = F) == T),]# tiles of interest

# list of scenes of interest
s2sc <- list.files(S2folder,pattern = '*.zip')# all available scenes
spl <- str_split(s2sc,'_')
s_dts <- as.Date(substr(unlist(lapply(spl, `[[`, 4)),1,8),'%Y%m%d')# dates of available scenes
s_tls <- unlist(lapply(spl, `[[`, 7))# tile numbers of available scenes
startdt <- as.Date(paste(sprintf("%02d", starttime),collapse =''),'%Y%m%d')# start period of interest
enddt <- as.Date(paste(sprintf("%02d", endtime),collapse =''),'%Y%m%d')# end period of interest
s2sel <- s2sc[which((s_dts > startdt) & (s_dts < enddt) & (s_tls %in% paste0('T',tiles$Name)))]# scenes that meet requirements

# generate scenes to level 1 folder
for(i in 1:length(tiles$Name)){
  # generate the folder for the Sentinel-2 tile
  if(!dir.exists(file.path(l1folder,'sentinel',paste0('T',tiles$Name[i])))){dir.create(file.path(l1folder,'sentinel',paste0('T',tiles$Name[i])))}
}

# unzip scenes in the right folder
library(tidyverse)
walk(s2sel, ~ unzip(zipfile = file.path(S2folder, .x), 
                         exdir = file.path(l1folder,'sentinel',paste0('T',substr(.x,50,55)))))
# add scenes to queue
line <-paste(paste0(file.path(l1folder,'sentinel',substr(s2sel,50,55), paste0(substr(s2sel,12,71),'.SAFE')),' QUEUED'), collapse = '\n')
write(line,file=file.path(queuefolder,queuefile),append=TRUE)
  
# s2sc <- c('2020-08-11_S2B_MSIL1C_20190609T132239_N0207_R038_T23MPQ_20190609T150131.zip',
# '2020-08-11_S2B_MSIL1C_20190609T132239_N0207_R038_T23MPR_20190609T150131.zip',
# '2020-08-11_S2B_MSIL1C_20190619T132239_N0207_R038_T23MPQ_20190619T150157.zip',
# '2020-08-11_S2B_MSIL1C_20190619T132239_N0207_R038_T23MPR_20190619T150157.zip',
# '2020-08-11_S2B_MSIL1C_20190629T132239_N0207_R038_T23MPQ_20190629T133645.zip',
# '2020-08-11_S2B_MSIL1C_20190629T132239_N0207_R038_T23MPR_20190629T133645.zip')


```

# Download the DEM and generate a VRT
```{r}
# download DEM over study area
flsDEM <- dllDEM(ext, dl_dir= demfolder, logfile = demlogfile)

# generate a vrt
system(paste0("find ",demfolder," -name '*.hgt' > ",file.path(demfolder,'srtm.txt')), intern = TRUE, ignore.stderr = TRUE)
system(paste0("gdalbuildvrt -input_file_list ",file.path(demfolder,'srtm.txt')," ",file.path(demfolder,'srtm.vrt')))
```

# Download the WVP data
```{r}
dllWVP(wvpfolder, logfile = wvplogfile)
```

# Process the level 1 data to level 2 and generate a vrt

- process data to level 2
- generate vrt
- summarize log files of all scenes
```{r}
Landsat2L2(paramfolder, paramfile, l2folder, LSscenes, logfolder, Sskiplogfile, Ssuccesslogfile, Smissionlogfile, Sotherlogfile)
```

