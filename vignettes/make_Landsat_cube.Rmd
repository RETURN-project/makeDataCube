---
title: "Generate Landsat data cube"
author: "Wanda De Keersmaecker and Pablo Rodríguez-Sánchez"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Generate Landsat data cube}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      eval = FALSE)
library(reticulate)
library(makeDataCube)
library(tidyverse)
library(sf)
library(unixtools)
```

```{r python, include=FALSE}
# Find Python in this machine (location may vary across users)

import("pylandsat") # Tip: this loads the (first) Python environment containing pylandsat (installed via `pip install pylandsat`). 

# If a specific environment is required, use: 
#
# `use_python(<python path>, required = TRUE)` # Where <python path> could be, for instance, "anaconda3/bin/python"
# or
# `use_condaenv(<environment name>)`
# or
# `use_virtualenv(<environment name>)`
# instead of `import`.
#
# Note: changing Python version requires restarting RStudio.

py_config()
```

# General
This document generates a data cube of level-2 Landsat and Sentinel-2 data over a user-defined area and study period, using only Landsat data below a user-defined cloud coverage threshold. The Landsat Level-1 scenes are downloaded from the public dataset hosted on Google Cloud, while Sentinel-2 Level-1 scenes should be available locally. These scenes are processed to Level-2 and a data cube is generated using FORCE software.

## Requirements
- [**Python 3**](https://www.python.org/downloads/) should be installed.
  - The [**pylandsat**](https://pypi.org/project/pylandsat/) and [**shapely**](https://pypi.org/project/Shapely/) modules should be available to download data. Both can be installed installed via `pip install pylandsat` and `pip install shaoely`.
- In addition, [**FORCE**](https://github.com/davidfrantz/force) should be installed. **FORCE** allows to generate a data cube of level-2 (or higher) Landsat and Sentinel-2 imagery from level-1 inputs. Please visit the [project's website](https://github.com/davidfrantz/force) for more information and download instructions. 
- The user should have a **NASA Earthdata account** to download DEM data. The _Login_, _Username_ and _Password_ are stored in a _netrc_ file in the home directory. If no _netrc_ file is found, you will be asked to provide your _Username_ and _Password_ and a _netrc_ file will automatically be created (and stored for a next session). If you don't have an account yet, you can create one [here](https://urs.earthdata.nasa.gov).
- Finally, you need authentication to download data from the LAADS DAAC (WVP data). To that end, you need an create a _.laads_ file is in your home directory with a an **App Key**. The **App Key** can be requested from [NASA Earthdata](https://ladsweb.modaps.eosdis.nasa.gov/tools-and-services/data-download-scripts/#requesting). This key should be stored in a file _.laads_ in your home directory.

## Inputs

```{r inputs}
# the folder where the datacube (and auxilliary data) will be stored
forcefolder <- normalizePath(file.path('..', 'data'))#forcefolder <- '/home/wanda/Documents/data/force'
# a directory where Sentinel-2 level 1C data are stored
S2folder <- normalizePath(file.path('..', 'data'))
# a directory where all temporary R files should be stored
Rtmpfolder <- normalizePath(file.path('..', 'data'))
#extent of the area of interest, vector with xmin, xmax, ymin, ymax in degrees
ext <- c(-43.38238361637443,-43.27938679020256,-4.555765244985907,-4.451717415449725)
# maximum cloud cover of the Landsat images (images with higher cloud cover will not be downloaded)
cld <- 50 
# start date of the study period: year, month, day
starttime <- c(2000,11,01)
# end date of the study period: year, month, day
endtime <- c(2001,5,28)
#Tier level of Landsat data (gives information about the quality of the data)
tiers <- 'T1'
# Landsat sensors of interest
sensors <- c('LC08', 'LE07', 'LT05', 'LT04')#sensors, 'LM05', 'LM04'
```

## Generate the directory structure

```{r folders}
# set the folder to store temporary data
unixtools::set.tempdir(Rtmpfolder)
# set the upper memory limit for raster data. Raster will move data to disk if it exceeds the upper limit (defaults to 100MB). 
# options(rasterMaxMemory = 1e10)
# generate folder structure
fldrs <- setFolders(forcefolder)
tmpfolder <- fldrs['tmpfolder']
l1folder <- fldrs['l1folder']
l2folder <- fldrs['l2folder']
queuefolder <- fldrs['queuefolder']
queuefile <- fldrs['queuefile']
demfolder <- fldrs['demfolder']
wvpfolder <- fldrs['wvpfolder']
logfolder <- fldrs['logfolder']
paramfolder <- fldrs['paramfolder']
demlogfile <- fldrs['demlogfile']
wvplogfile <- fldrs['wvplogfile']
landsatlogfile <- fldrs['landsatlogfile']
Sskiplogfile <- fldrs['Sskiplogfile']
Ssuccesslogfile <- fldrs['Ssuccesslogfile']
Smissionlogfile <- fldrs['Smissionlogfile']
Sotherlogfile <- fldrs['Sotherlogfile']
S2auxfolder <- fldrs['S2auxfolder']
```

## Generate a parameter file

```{r parameters}
# more information about the parameter settings can be found in https://davidfrantz.github.io/tutorials/force-ard/l2-ard/
# or https://force-eo.readthedocs.io/en/latest/components/lower-level/level2/param.html
source_python(system.file("python", "makeParFile.py", package = "makeDataCube"))

paramfile <- 'l2param.prm'
demfile <- 'srtm.vrt'
makeParFile(paramfolder, file.path(paramfolder, paramfile), FILE_QUEUE = file.path(queuefolder, queuefile), DIR_LEVEL2 = l2folder, DIR_LOG = logfolder, DIR_TEMP = tmpfolder, FILE_DEM = file.path(demfolder, demfile), ORIGIN_LON = '-90', ORIGIN_LAT = '60', RESAMPLING = 'NN', DIR_WVPLUT = wvpfolder, RES_MERGE = 'REGRESSION',  NPROC = '1', NTHREAD = '1', DELAY = '10', OUTPUT_DST = 'TRUE',  OUTPUT_VZN = 'TRUE', OUTPUT_HOT = 'TRUE', OUTPUT_OVV = 'TRUE', DEM_NODATA= '-32768',TILE_SIZE = '3000',BLOCK_SIZE = '300')

# Expected outputs:
# {paramfolder}/l2param.prm (typically data/param/l2param.prm) # Parameter file
# {paramfolder}/l2param.prm.bak (typically data/param/l2param.prm.bak) # Parameter file backup
```
 
## Search Landsat scenes, download and add to queue

```{r Landsat}
LSscenes <- dllLS(l1folder, queuefolder, queuefile, tmpfolder, landsatlogfile, ext, starttime, endtime, sensors, tiers, cld)
dllList <- LSscenes[[1]] # The scenes that have actually been downloaded in this execution
scenes <- LSscenes[[2]] # The total list of scenes to be processed
```

## Add Sentinel-2 data to queue

```{r Sentinel}
addSen2queue(S2auxfolder, ext, S2folder, starttime, endtime, queuefolder, queuefile, l1folder)

# Expected output:
# {S2auxfolder}/S2grid.kml (typically: data/misc/S2/S2grid.kml)
```

## Download the Digital Elevation Map (DEM)

```{r DEM}
# download DEM over study area
flsDEM <- dllDEM(ext, dl_dir= demfolder, logfile = demlogfile)

```

## Generate a Gdal Virtual Format (VRT)

```{r VRT}
# generate a vrt
system(paste0("find ",demfolder," -name '*.hgt' > ",file.path(demfolder,'srtm.txt')), intern = TRUE, ignore.stderr = TRUE)
system(paste0("gdalbuildvrt -input_file_list ",file.path(demfolder,'srtm.txt')," ",file.path(demfolder,'srtm.vrt')))
```

## Download the Water Vapor Database (WVP) data
```{r WVP}
dllWVP(wvpfolder, logfile = wvplogfile)
```

## Process the level 1 data to level 2 and generate a VRT

- Process data to level 2
- Generate VRT
- Summarize log files of all scenes

```{r process}
Landsat2L2(paramfolder, paramfile, l2folder, scenes, logfolder, Sskiplogfile, Ssuccesslogfile, Smissionlogfile, Sotherlogfile)
```

