---
title: "Generate a mask file and add it to the data cube"
author: "Wanda De Keersmaecker"
date: "7/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval =F)
library(makeDataCube)
```

# General 
The goal of this vignette is to generate a mask file and add it to an existing data cube with optical data. This cube should be generated with the FORCE software and follow the folder structure as defined in make_Landsat_cube.Rmd. If no data cube is available, please generate one first. 

The mask equals 1 for pixels that meet the following requirements:

- Have a tree cover percentage higher than xxx
- Being burned with a confidence level higher than xxx
- Have not been classified as a non-natural land cover type 
- Are classified as forest in the beginning of the study period

Other pixels are set to 0.

## Inputs
```{r}
forcefolder <- '/home/wanda/Documents/data/force'#Sys.getenv("HOME")#'/home/wanda/Documents/data/force'
ext <- c(-43.38238361637443,-43.27938679020256,-4.555765244985907,-4.451717415449725)#extent, vector with xmin, xmax, ymin, ymax in degrees
starttime <- c(1998,01,01)#start date: year, month, day
endtime <- c(2018,12,31)#end date: year, month, day

```

## Generate the directory structure
A standard structure of the data folders is assumed. 

```{r}
tmpfolder <- file.path(forcefolder, 'temp') # temporary files
queuefolder <- file.path(forcefolder, 'level1')# queue file
queuefile <- 'queue.txt'# name queue file
lcfolder <- file.path(forcefolder, 'misc','lc')# raw land cover data
tcfolder <- file.path(forcefolder, 'misc','tc')# raw tree cover data
firefolder <- file.path(forcefolder, 'misc','fire')# raw fire data
paramfolder <- file.path(forcefolder, 'param') # parameter file
paramfile <- 'l2param.prm'# name parameter file
extfolder <- file.path(forcefolder, 'temp', paste0('Area', ext[1],'_', ext[2],'_', ext[3],'_', ext[4]))# folder with temporary data for the study area of interest

if(!dir.exists(lcfolder)){dir.create(lcfolder)}
if(!dir.exists(tcfolder)){dir.create(tcfolder)}
if(!dir.exists(firefolder)){dir.create(firefolder)}
if(!dir.exists(extfolder)){dir.create(extfolder)}
```

## Prepare land cover data
First MapBiomas land cover data are downloaded if they are not available yet. Then the land cover data are cropped to the extent of the study area, and the study period of interest. Currently, MapBiomas data are only available for the years 1985 - 2018.

```{r}
# Download MapBiomas land cover data
dllLandcover(lcfolder)
# Crop the land cover data to exent and time period of interest 
prepLandcover(lcfolder, extfolder, ext, fname = 'landcover.tif', as.Date(paste0(starttime[1],'-',starttime[2],'-',starttime[3])), as.Date(paste0(endtime[1],'-',endtime[2],'-',endtime[3])))

```

## Prepare tree cover data
```{r}
# Download tree cover data
tcfls <- dllTreecover(tcfolder, ext)
# Crop the tree cover data to exent of interest and mask nodata values
prepTreecover(tcfolder, extfolder, ext, fname = 'treecover.tif', tcfls$hanfiles, tcfls$hanmaskfiles)
```

## Prepare fire data
```{r}
# Download fire data
firefls <- dllFire(firefolder)
# Crop the fire data to exent and time period of interest 
prepFire(firefolder, extfolder, ext, fjdname = 'fireJD.tif', fclname = 'fireCL.tif', as.Date(paste0(starttime[1],'-',starttime[2],'-',starttime[3])), as.Date(paste0(endtime[1],'-',endtime[2],'-',endtime[3])), firefls$fireclfiles, firefls$firejdfiles)
```

## Generate mask
```{r}

```

## Add to data cube
```{r}

```


















